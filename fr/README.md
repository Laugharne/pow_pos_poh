![](assets/pow_pos_poh.png)


# PoW ; PoS ; PoH

> **AVERTISSEMENT :** Pour tous les *"Jean-Michel-Premier-degr√©"*, les extraits de code dans cet article ne sont l√† qu'√† titre d'illustration. Ce sont des versions **tr√®s simplifi√©es** des algorithmes de consensus, juste pour en illustrer le fonctionnement.


## TL;DR

1. Le m√©canisme de consensus est un proc√©d√© par lequel les n≈ìuds d'un r√©seau pair √† pair se mettent d'accord sur un ensemble d'informations.
2. Le choix de l'algorithme de consensus a des implications sur la s√©curit√©, la d√©centralisation, la consommation √©nerg√©tique et divers aspects d'une blockchain.


## Introduction

Les algorithmes de **consensus** permettent de se mettre d'accord sur une **version commune et unique** des donn√©es partag√©es par une blockchain, et ce, malgr√© la possible pr√©sence de n≈ìuds **d√©faillants** ou **malveillants**.

Les r√¥les des algorithmes de consensus sont les suivants :
1. **Accord sur l'√©tat partag√© :** Prouver que les transactions sont valides, leurs ordres, leurs origines.
2. **R√©sistance aux d√©faillances :** √ätre robuste. Le r√©seau doit fonctionner correctement m√™me en pr√©sence de n≈ìuds d√©faillants ou malveillants.
3. **D√©centralisation :** √âviter la n√©cessit√© d'une autorit√© centrale. Cela permet une r√©sistance accrue √† la censure et √† la centralisation d'une autorit√©.
4. **S√©curit√© :** Garantir l'int√©grit√© des donn√©es, pas d'alt√©ration, pr√©server l'unicit√©.

La **synchronicit√©** et l'**unicit√©** en sont deux √©l√©ments tr√®s importants. En effet, savoir quand une transaction est arriv√©e en premier par rapport √† une autre, de m√™me que la garantie que les balances de comptes soient correctes sont essentielles, sinon il y a un risque de **double d√©pense**.

Il existe bien des mani√®res de faire. En voici trois parmi les plus importantes ou usit√©es.
- La **preuve de travail** (*proof of work*) utilis√©e pour le **Bitcoin**.
- La **preuve d'enjeu** (*proof of stake*) utilis√©e maintenant par **Ethereum**.
- La **preuve d'historique** (*proof of history*) pr√©sente sur **Solana**.



## ‚öíÔ∏è Proof of Work (PoW)

La preuve de travail est la premi√®re m√©thode de consensus utilis√©e dans **Bitcoin** bas√©e sur l‚Äôalgorithme **SHA-256** utilis√© pour cr√©er l‚Äôempreinte num√©rique d‚Äôun document. Pour chaque bloc, un n≈ìud doit trouver une solution √† un "*puzzle*" math√©matique qui d√©pend du contenu du bloc et de son pr√©c√©dent, [comme illustr√© ici](https://andersbrownworth.com/blockchain/blockchain) (üá¨üáß).

Notez qu‚Äôil n‚Äôy a pas de limite de nombre de participants car nul ne peut dire si quelqu‚Äôun va arriver en premier.

√Ä cela s'ajoute la notion de **difficult√©** de calcul qui consiste en un nombre variable et minimale de z√©ros √† obtenir en d√©but de r√©sultat de hash (*leading zeros*) avec usage d'un *nonce* dans des it√©rations de calcul. Cette [difficult√© est ajust√©e](https://www.blockchain.com/explorer/charts/difficulty) tous les **2016 blocs** (environs deux semaines) de mani√®re √† conserver un temps moyen entre chaque blocs en dessous de **10 minutes**.

Le premier n≈ìud √† r√©soudre correctement le calcul est r√©compens√© par un certain nombre de bitcoins. Les n≈ìuds vont essayer de trouver cette solution en utilisant leur puissance de calcul. Le temps n√©cessaire pour trouver la solution peut varier mais il y aura toujours un gagnant d‚Äôune quantit√© de Bitcoins.

Initialement, la r√©compense √©tait de 50 bitcoins par bloc, mais cela est r√©duit de moiti√© environ tous les quatre ans dans un √©v√©nement connu sous le nom de ["**halving**"](https://buybitcoinworldwide.com/halving/) (üá¨üáß).

Au prochain halving (*article √©crit d√©but 2024*) qui aura lieu courant **2024**, la r√©compense passera de **6,25 BTC** √† **3,125 BTC** par bloc.


![](assets/difficulty.png)

(*source : [buybitcoinworldwide.com](https://buybitcoinworldwide.com/halving/)*)


**Version simplifi√©e du minage (PoW) en Rust :**

```rust
fn mining_block(previous_block_hash: String, current_transactions: &Block, difficulty: usize) -> (String, u32) {
    let prefix: String = "00".repeat(difficulty);
    let mut nonce: u32 = 0;

    loop {
        let to_hash: String    = format!("{}{}{}{}", previous_block_hash, current_transactions.index, current_transactions.data, nonce);
        let block_hash: String = digest(to_hash);
        
        if block_hash.starts_with(&prefix) {
            return (block_hash, nonce);
        } else {
            nonce += 1;
        }
    }
}
```

> Sur une courte s√©quence de **5 blocs**, ma simulation de calcul a d√ª proc√©der √† **370894 calculs de hashs** avant de les valider tous.


## üí∞ Proof of Stake (PoS)

La preuve d‚Äôenjeu est une alternative √† la preuve de travail. Elle est utilis√©e par **Ethereum**. Contrairement √† Bitcoin o√π les participants (*mineurs*) r√©solvent des probl√®mes complexes pour ajouter un bloc √† la blockchain, la PoS requiert des efforts informatiques beaucoup moins intensifs.

Les participants (*validateurs*) sont choisis pour ajouter un nouveau bloc en fonction d'une quantit√© de cryptomonnaie qu'ils sont pr√™ts √† **"mettre en jeu"** **(staker)** en tant que garantie. Plus un participant en d√©tient et est dispos√© √† la bloquer, plus il a de chances d'√™tre s√©lectionn√© pour cr√©er un bloc. Les validateurs seront soit r√©compens√©s (*jetons, frais de transaction*) pour leur travail, soit [p√©nalis√© en cas de malveillance](https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/#pos-and-security) (üá¨üáß).

Le choix des validateurs est d√©termin√© par leur **enjeu** et il n'y a ainsi donc pas de n√©cessit√© √† r√©soudre des probl√®mes math√©matiques complexes. Par cons√©quent, la difficult√© au sens de la recherche de *leading zeros* n'est pas applicable dans le contexte de ce consensus.

L'id√©e fondamentale √©tant que les individus/entit√©s qui ont un **int√©r√™t financier** dans la stabilit√© et la s√©curit√© du r√©seau sont moins susceptibles de se comporter de mani√®re malveillante. Leur participation au consensus est bas√©e sur la possession d'une quantit√© de cryptomonnaie mise en jeu plut√¥t que sur la puissance de calcul.


**Version simplifi√©e de cr√©ation de bloc (PoS) en Rust :**

```rust
fn creation_block(previous_block_hash: String, current_transactions: &Block) -> String {
    let to_hash: String    = format!("{}{}{}", previous_block_hash, current_transactions.index, current_transactions.data);
    let block_hash: String = digest(to_hash);
    block_hash
}
```

> Sur la m√™me s√©quence de **5 blocs** que pr√©c√©demment, il n'a fallu calculer que **5 hashs** pour les valider tous.


## üìú Proof of History (PoH)

La preuve d'historique est utilis√©e par **Solana**. Reposant sur une base de donn√©es distribu√©e appel√©e *Account State*. Chaque transaction est stock√©e dans cette base de donn√©es. Pour qu'elles soient accept√©es, elles doivent √™tre li√©es √† une **transaction pr√©c√©dente** existante. La validation d'une transaction pr√©c√©dente implique la validation de **toutes ses suivantes**.

En prenant un exemple simple, imaginez une **cha√Æne de montagnes** : pour en atteindre la fin, il faut d'abord gravir le premier sommet, puis le suivant, etc., jusqu'√† atteindre le sommet final. La preuve d'historique garantit la validit√© de chaque transaction encha√Ænant la sienne √† la pr√©c√©dente.

La PoS ajoute un registre d'historique des transactions et des blocs √† chaque n≈ìud. Cela permet aux utilisateurs de v√©rifier si leurs transactions ont √©t√© incluses dans le r√©seau ou pas.

En 2008, **Satoshi Nakamoto**, dans son **["White paper"](https://bitcoin.org/bitcoin.pdf)** (üá¨üáß) a introduit le concept de "**timestamp server**". Bien qu'il n'utilise pas explicitement le terme "*blockchain*" dans ce document, il d√©crit les principes fondamentaux qui sous-tendent la technologie blockchain. Le "*timestamp server*" √©tait un √©l√©ment cl√© pour s√©curiser l'ordre chronologique des transactions dans le syst√®me Bitcoin.

> Le terme "*blockchain*" par la suite, est devenu plus couramment utilis√© pour d√©crire la structure de donn√©es d√©centralis√©e qui enregistre de mani√®re immuable les transactions au travers de blocs connect√©s les uns aux autres √† l'aide de fonctions de hachage cryptographiques.

Comme dit dans l'introduction, la synchronicit√© des... **BLABLABLA**

Par exemple chez Google, il est utilis√© une horloge atomique afin de maintenir une unicit√© de temps entre tous ses services. Les blockchains n'utilisents pas ce genre de solution externe pour r√©soudre leur probl√®me d'unicit√© de temps.

L'horodatage est directement encod√© dans les messages de transaction.


(horodat√©, associer une valeur temporelle √† un √©venement)

La cha√Æne de blocs peut √™tre construite √† partir d'un ensemble de transactions horodat√©e. Cela signifie que chaque message de transaction contient une information sur son temps et qu'il est possible de d√©terminer si un message a √©t√© ajout√© avant ou apr√®s un autre message. Cela permet √©galement de v√©rifier que toutes les transactions sont bien ordonn√©es chronologiquement.


Le PoH utilise une technique appel√©e "tick-counting" pour mesurer le temps. Chaque tick correspond √† une petite quantit√© de temps r√©elle, mais il y a beaucoup plus de ticks par seconde que de secondes par tick. Les ticks sont utilis√©s pour incr√©menter un compteur qui mesure le nombre de ticks pass√©s depuis le d√©but de l'univers. Ceci permet de g√©n√©rer une valeur unique pour chaque transaction, m√™me s'ils ont lieu presque exactement au m√™me moment.


Il est important de noter que le PoH ne garantit pas la chronologie absolue des transactions mais uniquement leur ordonnance relative. Cela signifie qu'une transaction peut arriver apr√®s une autre m√™me si elle est ant√©rieure.

Preuve d'ordonancement pourrait aussi √™tre un terme utilisable pour la PoH.

...

Le PoH utilise une fonction `tick()` qui incr√©mente un compteur √† chaque nouvelle transaction et ajoute cette valeur au hash du message de transaction. Cela permet de s'assurer que toutes les transactions sont ordonn√©es par rapport aux autres. La preuve d'historique est donc fournie par ce tick() qui est incorpor√© dans chaque message de transaction. On peut imaginer qu'il y ait un "ticker" central qui g√©n√®re un nombre unique √† chaque appel de `tick()`. Les utilisateurs peuvent alors ajouter ce num√©ro √† leur message de transaction. Le n≈ìud qui valide la transaction v√©rifie si le num√©ro est sup√©rieur ou √©gal au pr√©c√©dent. Si c'est le cas, il accepte la transaction. Sinon, il rejette la transaction et attend jusqu'√† ce que le ticker change.

...

**Version simplifi√©e de cr√©ation de bloc (PoH) en Rust :**

```rust
// TODO
```



## Conclusions


--------

Cr√©dits : **[Franck Maussand](mailto:franck@maussand.net)**

*Merci √† [**Igor Bournazel**](https://github.com/ibourn) pour ses suggestions et la relecture de cet article.*

N'h√©sitez pas √† jeter un coup d'oeil sur mon pr√©c√©dent article sur le [**function dispatcher des EVM**](https://medium.com/@franck.maussand/optimisation-sur-ethereum-faites-la-diff%C3%A9rence-avec-les-noms-de-fonctions-ba4692c9e39f) !

--------


## Ressources additionnelles

- **Hash :**
  - üá´üá∑ [Fonction de hachage ‚Äî Wikip√©dia](https://fr.wikipedia.org/wiki/Fonction_de_hachage)
  - üá¨üáß [Hash function - Wikipedia](https://en.wikipedia.org/wiki/Hash_function)
  - üá´üá∑ [SHA-3 ‚Äî Wikip√©dia](https://fr.wikipedia.org/wiki/SHA-3)
  - üá¨üáß [SHA-3 - Wikipedia](https://en.wikipedia.org/wiki/SHA-3)
  - üá¨üáß [Blockchain Demo - Hash](https://andersbrownworth.com/blockchain/hash)


- **PoW :**
  - üá´üá∑ [Bitcoin : un syst√®me de paiement √©lectronique pair-√†-pair](https://bitcoin.org/files/bitcoin-paper/bitcoin_fr.pdf)
  - üá¨üáß ["Bitcoin: A Peer-to-Peer Electronic Cash System"](https://bitcoin.org/bitcoin.pdf)
  - üá¨üáß [Blockchain Demo - Blockchain](https://andersbrownworth.com/blockchain/blockchain)
  - üá¨üáß [What is Proof of Work? (Cryptocurrency Explanation)](https://www.youtube.com/watch?v=XLcWy1uV8YM)
  - üá¨üáß [Blockchain.com | Charts - Network Difficulty](https://www.blockchain.com/explorer/charts/difficulty)
  - üá¨üáß [Next Bitcoin Halving 2024 Date & Countdown [BTC Clock]](https://buybitcoinworldwide.com/halving/)


- **PoS :**
  - üá´üá∑ [Proof of work / Proof of Stake : C'est quoi la diff√©rence ?](https://www.youtube.com/watch?v=dEGcAXeQsns)
  - üá¨üáß [Proof-of-stake (PoS) | ethereum.org](https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/)
  - üá¨üáß [Proof-of-stake and security](https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/#pos-and-security)
  - üá¨üáß [What is Proof of Stake & How Does Confirmation Work in PoS?](https://coindcx.com/blog/crypto-basics/what-is-proof-of-stake-pos/)


- **PoH :**
  - üá¨üáß [Solana: A new architecture for a high performance blockchain](https://solana.com/solana-whitepaper.pdf)
  - üá¨üáß [Proof of History: A Clock for Blockchain](https://medium.com/solana-labs/proof-of-history-a-clock-for-blockchain-cf47a61a9274)
  - üá¨üáß [Proof of History: How Solana brings time to crypto | Solana](https://solana.com/news/proof-of-history)
  - üá¨üáß [Break | Solana](https://break.solana.com/)
  - üá¨üáß [Proof of History Explained by a Water Clock](https://medium.com/solana-labs/proof-of-history-explained-by-a-water-clock-e682183417b8)


- **VDF :**
  - üá¨üáß [Timelock Puzzles Using VDFs](https://medium.com/mistywest/timelock-puzzles-using-vdfs-b5636503950d)
  - üá¨üáß [Day 54: VDFs: Verifiable Delay Functions in Blockchain](https://gsoares-block.medium.com/day-54-vdfs-verifiable-delay-functions-in-blockchain-addb3d89a72b)
  - üá¨üáß [Verifiable Delay Functions](https://www.youtube.com/watch?v=_-feyaZZjEw)
  - üá¨üáß [Verifiable Delay Functions: Applications and Candidate Constructions - BPASE '18](https://www.youtube.com/watch?v=qUoagL7OZ1k)


